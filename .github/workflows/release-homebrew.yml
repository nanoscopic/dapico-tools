name: Release Homebrew Formula

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to publish (e.g. 0.1.2)"
        required: true
        type: string
      commit_body:
        description: "Detailed homebrew-core commit description."
        required: true
        type: string

permissions:
  contents: read

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dapico-tools
        uses: actions/checkout@v4

      - name: Prepare release metadata
        id: release
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          url="https://github.com/nanoscopic/dapico-tools/archive/refs/tags/${TAG}.tar.gz"
          tmp_file="$(mktemp)"
          trap 'rm -f "$tmp_file"' EXIT
          curl -fsSL "$url" -o "$tmp_file"
          sha256="$(sha256sum "$tmp_file" | awk '{print $1}')"
          echo "url=$url" >> "$GITHUB_OUTPUT"
          echo "sha256=$sha256" >> "$GITHUB_OUTPUT"

      - name: Prepare homebrew-core base
        run: |
          set -euo pipefail
          mkdir -p homebrew-core
          cd homebrew-core
          git init
          git fetch --depth=1 https://github.com/Homebrew/homebrew-core.git main
          git checkout -B pr-base FETCH_HEAD

      - name: Update dapico-tools formula
        id: update-formula
        env:
          RELEASE_URL: ${{ steps.release.outputs.url }}
          RELEASE_SHA256: ${{ steps.release.outputs.sha256 }}
          TAG: ${{ inputs.tag }}
          FORMULA_TEMPLATE: ${{ github.workspace }}/Formula/dapico-tools.rb.in
        run: |
          set -euo pipefail
          cd homebrew-core
          formula_path="Formula/d/dapico-tools.rb"
          python - <<'PY'
          import os
          import re
          from pathlib import Path
          formula_path = Path("Formula/d/dapico-tools.rb")
          url = os.environ["RELEASE_URL"]
          sha256 = os.environ["RELEASE_SHA256"]
          template_path = Path(os.environ["FORMULA_TEMPLATE"])

          is_new = not formula_path.exists()
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output:
              output.write(f"is_new={str(is_new).lower()}\n")

          if is_new:
              formula_path.parent.mkdir(parents=True, exist_ok=True)
              new_content = template_path.read_text(encoding="utf-8")
              formula_path.write_text(
                  new_content.replace("@URL@", url).replace("@SHA256@", sha256),
                  encoding="utf-8",
              )
              raise SystemExit(0)

          content = formula_path.read_text()
          new_content, url_count = re.subn(r'^\s*url\s+"[^"]+"\s*$', f'  url "{url}"', content, count=1, flags=re.M)
          new_content, sha_count = re.subn(r'^\s*sha256\s+"[^"]+"\s*$', f'  sha256 "{sha256}"', new_content, count=1, flags=re.M)

          if url_count == 0 or sha_count == 0:
            raise SystemExit("Failed to locate url/sha256 entries in formula.")

          formula_path.write_text(new_content)
          PY

      - name: Commit and push changes
        env:
          HOMEBREW_CORE_PAT: ${{ secrets.HOMEBREW_CORE_PAT }}
          TAG: ${{ inputs.tag }}
          COMMIT_BODY: ${{ inputs.commit_body }}
        run: |
          set -euo pipefail
          cd homebrew-core
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          if [ "${{ steps.update-formula.outputs.is_new }}" = "true" ]; then
            branch="add-formula-dapico-tools"
          else
            branch="update-formula-dapico-tools-to-${TAG}"
          fi
          git checkout -B "$branch"
          if [ -z "$(git status --porcelain)" ]; then
            echo "No formula changes detected; skipping commit."
            exit 0
          fi
          git add Formula/d/dapico-tools.rb
          if [ "${{ steps.update-formula.outputs.is_new }}" = "true" ]; then
            commit_summary="dapico-tools ${TAG} (new formula)"
          else
            commit_summary="dapico-tools ${TAG}"
          fi
          if [ -n "${COMMIT_BODY}" ]; then
            commit_body="${COMMIT_BODY}"
          else
            commit_body="Update the Homebrew formula for dapico-tools ${TAG}."
          fi
          commit_message_file="$(mktemp)"
          printf "%s\n\n%s\n" "${commit_summary}" "${commit_body}" > "${commit_message_file}"
          git commit -F "${commit_message_file}"
          rm -f "${commit_message_file}"
          if git remote get-url origin >/dev/null 2>&1; then
            git remote set-url origin "https://x-access-token:${HOMEBREW_CORE_PAT}@github.com/nanoscopic/homebrew-core.git"
          else
            git remote add origin "https://x-access-token:${HOMEBREW_CORE_PAT}@github.com/nanoscopic/homebrew-core.git"
          fi
          git push -u origin "$branch"

      - name: Open pull request to Homebrew/homebrew-core
        env:
          GH_TOKEN: ${{ secrets.MAKE_PR_PAT }}
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          cd homebrew-core
          if [ "${{ steps.update-formula.outputs.is_new }}" = "true" ]; then
            branch="add-formula-dapico-tools"
          else
            branch="update-formula-dapico-tools-to-${TAG}"
          fi
          if ! git ls-remote --exit-code origin "refs/heads/${branch}" >/dev/null; then
            echo "Branch ${branch} not found in fork; skipping PR."
            exit 0
          fi
          if gh pr list --repo Homebrew/homebrew-core --head "nanoscopic:${branch}" --json number --jq 'length > 0' | grep -q true; then
            echo "Pull request already exists for ${branch}."
            pr_url="$(gh pr view --repo Homebrew/homebrew-core --head "nanoscopic:${branch}" --json url --jq '.url')"
            echo "Draft PR: ${pr_url}"
            echo "Draft PR: ${pr_url}" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          pr_url="$(gh pr create \
            --repo Homebrew/homebrew-core \
            --head "nanoscopic:${branch}" \
            --base "main" \
            --draft \
            --title "Update dapico-tools formula for ${TAG}" \
            --body "## Summary
          - update the Homebrew formula for dapico-tools ${TAG}

          ## Testing
          - not run (automated workflow)")"
          echo "Draft PR: ${pr_url}"
          echo "Draft PR: ${pr_url}" >> "$GITHUB_STEP_SUMMARY"
