name: Build macOS binaries

on:
  workflow_dispatch:
    inputs:
      version:
        description: Release version to publish (e.g. 1.2.3)
        required: true
  release:
    types: [published]

jobs:
  build-macos:
    runs-on: macos-15
    env:
      BUILD_TYPE: Release
      RELEASE_VERSION: ${{ github.event.inputs.version }}
      CMAKE_OSX_ARCHITECTURES: arm64;x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build dapico-reboot
        run: |
          cmake -S dapico-reboot -B dapico-reboot/build -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DCMAKE_OSX_ARCHITECTURES="${CMAKE_OSX_ARCHITECTURES}"
          cmake --build dapico-reboot/build --config ${BUILD_TYPE}

      - name: Build dapico-load
        run: |
          cmake -S dapico-load -B dapico-load/build -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DCMAKE_OSX_ARCHITECTURES="${CMAKE_OSX_ARCHITECTURES}"
          cmake --build dapico-load/build --config ${BUILD_TYPE}

      - name: Collect build artifacts
        run: |
          mkdir -p dist/universal
          REBOOT_BIN="dapico-reboot/build/${BUILD_TYPE}/dapico-reboot"
          LOAD_BIN="dapico-load/build/${BUILD_TYPE}/dapico-load"
          if [[ ! -f "${REBOOT_BIN}" ]]; then
            REBOOT_BIN="dapico-reboot/build/dapico-reboot"
          fi
          if [[ ! -f "${LOAD_BIN}" ]]; then
            LOAD_BIN="dapico-load/build/dapico-load"
          fi
          cp "${REBOOT_BIN}" dist/universal/dapico-reboot
          cp "${LOAD_BIN}" dist/universal/dapico-load

      - name: Package artifacts
        run: |
          mkdir -p dist/packages
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && -n "${RELEASE_VERSION}" ]]; then
            VERSION=${RELEASE_VERSION}
          elif [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION=${GITHUB_REF_NAME}
          else
            VERSION=${GITHUB_SHA:0:7}
          fi
          cp dist/universal/dapico-reboot dist/packages/dapico-reboot
          cp dist/universal/dapico-load dist/packages/dapico-load
          tar -czf "dist/packages/dapico-reboot-${VERSION}-macos.tar.gz" -C dist/packages dapico-reboot
          tar -czf "dist/packages/dapico-load-${VERSION}-macos.tar.gz" -C dist/packages dapico-load

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: dist/packages/*.tar.gz

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/packages/*.tar.gz

      - name: Create release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: Release ${{ env.RELEASE_VERSION }}
          files: dist/packages/*.tar.gz
